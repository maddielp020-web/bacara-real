<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mesa de Bacar√° Cubano - FASE 4 COMPLETA</title>
    <link rel="stylesheet" href="css/mesa.css">
</head>
<body>
    <div class="mesa-wrapper">
        <!-- IMAGEN FONDO -->
        <img src="img/mesa-fondo.png.jpg" alt="Mesa de Bacar√°" class="mesa-imagen">
        
        <!-- CAPA PRINCIPAL -->
        <div class="mesa-overlay" id="mesa-overlay">
            <!-- CAJ√ìN DE CARTAS -->
            <div class="cajon-cartas" id="cajon-cartas">
                <div class="cartas-restantes" id="cartas-restantes">üÉè 416 cartas</div>
                <div class="estado-barajando" id="estado-barajando" style="display: none;">‚ôªÔ∏è Barajando...</div>
            </div>

            <!-- √ÅREA CENTRAL JUEGO -->
            <div class="area-central">
                <!-- CORONA -->
                <div class="mano-jugador" id="mano-corona">
                    <div class="carta-placeholder" id="carta1-corona">?</div>
                    <div class="carta-placeholder" id="carta2-corona">?</div>
                    <div class="puntuacion" id="puntuacion-corona">0</div>
                </div>
                <!-- RETADOR -->
                <div class="mano-jugador" id="mano-retador">
                    <div class="carta-placeholder" id="carta1-retador">?</div>
                    <div class="carta-placeholder" id="carta2-retador">?</div>
                    <div class="puntuacion" id="puntuacion-retador">0</div>
                </div>
            </div>

            <!-- APUESTAS ESPECTADORES -->
            <div class="apuestas-zone">
                <button class="apostar-btn" onclick="apostarUI('corona', 100)">Apostar üëë 100</button>
                <button class="apostar-btn" onclick="apostarUI('retador', 100)">Apostar ‚öîÔ∏è 100</button>
            </div>

            <!-- ALERTA COMISI√ìN -->
            <div class="comision-alert" id="comision-alert">-5% COMISI√ìN</div>

            <!-- HISTORIAL R√ÅPIDO -->
            <div class="historial-rapido" id="historial-rapido"></div>
        </div>
    </div>

    <!-- M√ìDULOS JS (FASE 3) -->
    <script src="js/mesa-cartas.js"></script>
    <script src="js/mesa-apuestas.js"></script>
    <script src="js/mesa-historial.js"></script>
    <script src="js/mesa-ui.js"></script>
    
    <script>
        // ==================== FASE 4 - INTEGRACI√ìN COMPLETA ====================
        function inicializarMesa() {
            console.log('üéÆ FASE 4 COMPLETA - Inicializando mesa...');
            
            // Crear jugadores UI
            crearJugadoresUI();
            
            // Iniciar simulador
            simularJuegoCompleto();
        }

        // ü¶Å JUGADORES CON ü™ô (FASE 2)
        function crearJugadoresUI() {
            const jugadores = [
                { clase: 'jugador-leon', avatar: 'ü¶Å', nombre: 'Le√≥n', fichas: 1250 },
                { clase: 'jugador-dragon', avatar: 'üêâ', nombre: 'Drag√≥n', fichas: 850 },
                { clase: 'jugador-conejo', avatar: 'üê∞', nombre: 'Conejo', fichas: 420 },
                { clase: 'jugador-aguila', avatar: 'ü¶Ö', nombre: '√Åguila', fichas: 2100 },
                { clase: 'jugador-cobra', avatar: 'üêç', nombre: 'Cobra', fichas: 675 },
                { clase: 'jugador-buho', avatar: 'ü¶â', nombre: 'B√∫ho', fichas: 980 }
            ];

            const overlay = document.getElementById('mesa-overlay');
            jugadores.forEach(j => {
                const div = document.createElement('div');
                div.className = `jugador ${j.clase}`;
                div.innerHTML = `
                    <span class="corona-badge" id="corona-${j.clase.replace('jugador-', '')}" style="display: none;">üëë CORONA</span>
                    <span class="retador-badge" id="retador-${j.clase.replace('jugador-', '')}" style="display: none;">‚öîÔ∏è RETADOR</span>
                    <span class="jugador-avatar">${j.avatar}</span>
                    <div class="jugador-nombre">${j.nombre}</div>
                    <div class="jugador-fichas">
                        <span class="ficha-casino">ü™ô</span>
                        <span class="fichas-numero" data-jugador="${j.clase.replace('jugador-', '')}">${j.fichas.toLocaleString()}</span>
                    </div>
                `;
                overlay.appendChild(div);
            });
        }

        // üé≤ SIMULADOR JUEGO COMPLETO (pruebas)
        function simularJuegoCompleto() {
            let coronaActual = 'leon';
            let retadorActual = 'dragon';

            setInterval(() => {
                // 1. REPARTIR CARTAS
                const mano = window.mesaCartas.nuevaMano();
                
                // 2. ACTUALIZAR UI CARTAS
                actualizarCartasUI(mano);
                
                // 3. DETERMINAR GANADOR
                const ganador = mano.manoActual.corona.puntuacion > mano.manoActual.retador.puntuacion ? 
                    'corona' : 'retador';
                
                // 4. PROCESAR APUESTAS + COMISI√ìN
                const resultado = window.procesarResultado(ganador);
                
                // 5. REGISTRAR HISTORIAL
                window.registrarMano({
                    coronaJugador: coronaActual,
                    coronaCartas: mano.manoActual.corona.cartas,
                    coronaPuntuacion: mano.manoActual.corona.puntuacion,
                    retadorJugador: retadorActual,
                    retadorCartas: mano.manoActual.retador.cartas,
                    retadorPuntuacion: mano.manoActual.retador.puntuacion,
                    ganador: ganador,
                    rachaCorona: resultado.rachaCorona,
                    comisionAplicada: resultado.comision,
                    apuestasCorona: window.mesaApuestas.obtenerEstado().apuestasCorona,
                    apuestasRetador: window.mesaApuestas.obtenerEstado().apuestasRetador,
                    cartasRestantes: window.mesaCartas.cartasRestantes
                });
                
                // 6. ROTAR ROLES
                rotarRoles(coronaActual, retadorActual);
                
                // 7. ACTUALIZAR TODO
                actualizarUICompleta();
                
            }, 7000);
        }

        // üîÑ ROTAR CORONA/RETADOR
        function rotarRoles(corona, retador) {
            // Ocultar indicadores actuales
            document.querySelectorAll('.corona-badge, .retador-badge').forEach(b => b.style.display = 'none');
            
            // Rotar retador cada 3 manos (simulado)
            const orden = ['leon', 'dragon', 'conejo', 'aguila', 'cobra', 'buho'];
            const idxRetador = orden.indexOf(retador);
            const nuevoRetador = orden[(idxRetador + 1) % 6];
            
            // Corona pasa a retador si pierde (50% chance simulada)
            const nuevoCorona = Math.random() > 0.6 ? nuevoRetador : corona;
            
            // Mostrar nuevos indicadores
            document.getElementById(`corona-${nuevoCorona}`).style.display = 'block';
            document.getElementById(`retador-${nuevoRetador}`).style.display = 'block';
        }

        // üñºÔ∏è ACTUALIZAR UI COMPLETA
        function actualizarUICompleta() {
            // Cartas
            window.mesaCartas.verificarBarajado();
            const estadoCartas = window.mesaCartas.obtenerEstado();
            document.getElementById('cartas-restantes').textContent = `üÉè ${estadoCartas.cartasRestantes} cartas`;
            document.getElementById('estado-barajando').style.display = estadoCartas.barajando ? 'block' : 'none';

            // Apuestas
            const estadoApuestas = window.mesaApuestas.obtenerEstado();
            if (estadoApuestas.comisionActiva) {
                document.getElementById('comision-alert').classList.add('mostrar');
                setTimeout(() => document.getElementById('comision-alert').classList.remove('mostrar'), 3000);
            }

            // Historial r√°pido
            const historial = window.obtenerHistorial();
            actualizarHistorialUI(historial.ultimasManos);

            // Fichas jugadores (simulado)
            actualizarFichasUI();
        }

        function actualizarCartasUI(mano) {
            // Corona
            document.getElementById('carta1-corona').textContent = mano.manoActual.corona.cartas[0]?.valor + mano.manoActual.corona.cartas[0]?.palo || '?';
            document.getElementById('carta2-corona').textContent = mano.manoActual.corona.cartas[1]?.valor + mano.manoActual.corona.cartas[1]?.palo || '?';
            document.getElementById('puntuacion-corona').textContent = mano.manoActual.corona.puntuacion;
            
            // Retador
            document.getElementById('carta1-retador').textContent = mano.manoActual.retador.cartas[0]?.valor + mano.manoActual.retador.cartas[0]?.palo || '?';
            document.getElementById('carta2-retador').textContent = mano.manoActual.retador.cartas[1]?.valor + mano.manoActual.retador.cartas[1]?.palo || '?';
            document.getElementById('puntuacion-retador').textContent = mano.manoActual.retador.puntuacion;
        }

        function actualizarHistorialUI(ultimasManos) {
            const historialDiv = document.getElementById('historial-rapido');
            historialDiv.innerHTML = ultimasManos.map(mano => 
                `<div>${mano.ganador} ${mano.coronaPuntos}-${mano.retadorPuntos} (${mano.comision})</div>`
            ).join('');
        }

        function apostarUI(destino, cantidad) {
            window.apostar(destino, cantidad);
        }

        function actualizarFichasUI() {
            // Simulaci√≥n fichas (l√≥gica real en bot Telegram futuro)
            document.querySelectorAll('.fichas-numero').forEach(el => {
                const jugador = el.dataset.jugador;
                el.textContent = (Math.floor(Math.random() * 2000) + 200).toLocaleString();
            });
        }

        // CSS INLINE para FASE 4 (mientras css/mesa.css no existe)
        const styles = `
            .cajon-cartas { position: absolute; top: 8%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,.9); border: 3px solid #d4af37; border-radius: 15px; padding: 12px 20px; text-align: center; backdrop-filter: blur(10px); box-shadow: 0 10px 30px rgba(0,0,0,.7); pointer-events: auto; }
            .area-central { position: absolute; top: 35%; left: 50%; transform: translate(-50%,-50%); width: 60%; height: 25%; display: flex; justify-content: space-between; align-items: center; pointer-events: none; }
            .mano-jugador { width: 120px; height: 80px; background: rgba(0,0,0,.6); border: 2px solid #888; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; pointer-events: auto; }
            .carta-placeholder { width: 35px; height: 50px; background: rgba(255,255,255,.1); border: 1px solid #666; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #ccc; }
            .puntuacion { background: rgba(0,0,0,.8); color: #d4af37; padding: 4px 10px; border-radius: 8px; font-weight: bold; font-size: 18px; border: 2px solid #d4af37; }
            .apuestas-zone { position: absolute; bottom: 12%; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; pointer-events: auto; }
            .apostar-btn { background: linear-gradient(135deg, #16a34a, #15803d); color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: bold; font-size: 14px; cursor: pointer; box-shadow: 0 4px 15px rgba(34,197,94,.4); transition: all .3s; }
            .apostar-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(34,197,94,.6); }
            .comision-alert { position: absolute; top: 25%; right: 5%; background: rgba(220,38,38,.95); color: white; padding: 8px 15px; border-radius: 10px; font-weight: bold; font-size: 14px; box-shadow: 0 6px 20px rgba(220,38,38,.5); opacity: 0; transform: translateY(-20px); transition: all .5s; }
            .comision-alert.mostrar { opacity: 1; transform: translateY(0); }
            .historial-rapido { position: absolute; bottom: 5%; left: 5%; background: rgba(0,0,0,.9); border: 2px solid #d4af37; border-radius: 10px; padding: 10px; max-height: 100px; overflow-y: auto; font-size: 12px; color: #d4af37; max-width: 150px; }
            .jugador { position: absolute; background: rgba(0,0,0,.85); border: 3px solid #d4af37; border-radius: 12px; padding: 10px 14px; text-align: center; backdrop-filter: blur(8px); box-shadow: 0 8px 25px rgba(0,0,0,.6); pointer-events: auto; transition: all .3s; }
            .jugador:hover { transform: scale(1.05); box-shadow: 0 12px 35px rgba(212,175,55,.4); }
            .corona-badge, .retador-badge { position: absolute; top: -15px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 10; }
            .corona-badge { left: 50%; transform: translateX(-50%); background: rgba(255,215,0,.95); color: #000; box-shadow: 0 4px 15px rgba(255,215,0,.5); }
            .retador-badge { right: -10px; background: rgba(220,38,38,.95); color: #fff; box-shadow: 0 4px 15px rgba(220,38,38,.5); }
            .jugador-avatar { font-size: 20px; margin-bottom: 4px; display: block; text-shadow: 0 2px 4px rgba(0,0,0,.8); }
            .jugador-nombre { color: #d4af37; font-size: 13px; font-weight: bold; margin-bottom: 6px; text-shadow: 0 1px 3px rgba(0,0,0,.8); }
            .jugador-fichas { display: flex; align-items: center; justify-content: center; gap: 6px; color: #fff; font-size: 16px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,.9); }
            .ficha-casino { font-size: 22px; filter: drop-shadow(0 3px 6px rgba(0,0,0,.7)) drop-shadow(0 0 8px rgba(255,215,0,.6)); }
            .fichas-numero { font-size: 16px; font-family: 'Courier New', monospace; }
            .jugador-leon { top: 46%; left: 2%; transform: translateY(-100%); }
            .jugador-dragon { top: 58%; left: 2%; transform: translateY(-50%); }
            .jugador-conejo { top: 70%; left: 2%; transform: translateY(0%); }
            .jugador-aguila { top: 46%; right: 2%; transform: translateY(-100%); }
            .jugador-cobra { top: 58%; right: 2%; transform: translateY(-50%); }
            .jugador-buho { top: 70%; right: 2%; transform: translateY(0%); }
        `;
        const style = document.createElement('style');
        style.textContent = styles;
        document.head.appendChild(style);
    </script>
</body>
</html>
